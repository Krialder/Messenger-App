version: '3.8'

# ===================================
# Production Configuration Override
# ===================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Features:
# - HTTPS/TLS via Nginx Reverse Proxy
# - No direct port exposure (only Nginx on 80/443)
# - Docker Secrets for sensitive data
# - Production environment variables
# - Auto-restart policies
# - Health checks enabled

services:
  # ===================================
  # Nginx Reverse Proxy (SSL Termination)
  # ===================================
  nginx:
    image: nginx:alpine
    container_name: messenger_nginx
    ports:
      - "80:80"     # HTTP (redirects to HTTPS)
      - "443:443"   # HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - gateway-service
    networks:
      - messenger_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===================================
  # Gateway Service (No direct exposure)
  # ===================================
  gateway-service:
    ports: []  # Override: Access only via Nginx
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - Jwt__Secret=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
    restart: unless-stopped

  # ===================================
  # Auth Service
  # ===================================
  auth-service:
    ports: []  # No direct exposure
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=postgres;Database=${POSTGRES_DB:-messenger_auth};Username=${POSTGRES_USER:-messenger_prod};Password=${POSTGRES_PASSWORD}
      - Jwt__Secret=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
      - Jwt__AccessTokenExpirationMinutes=${JWT_EXPIRY_MINUTES:-15}
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY}
      - Redis__Password=${REDIS_PASSWORD}
    restart: unless-stopped

  # ===================================
  # Message Service
  # ===================================
  message-service:
    ports: []  # No direct exposure
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__MessageDatabase=Host=postgres;Database=messenger_messages;Username=${POSTGRES_USER:-messenger_prod};Password=${POSTGRES_PASSWORD}
      - Jwt__SecretKey=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__UserName=${RABBITMQ_USER:-messenger_prod}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Redis__Password=${REDIS_PASSWORD}
    restart: unless-stopped

  # ===================================
  # User Service
  # ===================================
  user-service:
    ports: []  # No direct exposure
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__UserDatabase=Host=postgres;Database=messenger_users;Username=${POSTGRES_USER:-messenger_prod};Password=${POSTGRES_PASSWORD}
      - Jwt__Secret=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
    restart: unless-stopped

  # ===================================
  # PostgreSQL (No external access)
  # ===================================
  postgres:
    ports: []  # Only accessible within Docker network
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-messenger_production}
      - POSTGRES_USER=${POSTGRES_USER:-messenger_prod}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    restart: unless-stopped

  # ===================================
  # Redis (No external access)
  # ===================================
  redis:
    ports: []  # Only accessible within Docker network
    command: redis-server --requirepass ${REDIS_PASSWORD}
    restart: unless-stopped

  # ===================================
  # RabbitMQ (No external access)
  # ===================================
  rabbitmq:
    ports: []  # Only accessible within Docker network
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-messenger_prod}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
    restart: unless-stopped

# ===================================
# Networks (same as development)
# ===================================
networks:
  messenger_network:
    driver: bridge

# ===================================
# Volumes (persistent data)
# ===================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
