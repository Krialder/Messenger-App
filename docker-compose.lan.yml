version: '3.8'

# ===================================
# LAN-specific Configuration Override
# FÃ¼r Windows 11 Server - Internes Firmennetzwerk
# Verwendung: docker-compose -f docker-compose.yml -f docker-compose.lan.yml up -d
# ===================================
# Features:
# - HTTP only (kein SSL/TLS)
# - Nginx Reverse Proxy auf Port 80
# - Production Environment Variables
# - Auto-restart policies
# ===================================

services:
  # ===================================
  # Nginx Reverse Proxy (HTTP only - LAN)
  # ===================================
  nginx:
    image: nginx:alpine
    container_name: messenger_nginx_lan
    ports:
      - "80:80"     # HTTP only (kein HTTPS)
    volumes:
      - ./nginx/nginx-lan.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - gateway-service
    networks:
      - messenger_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===================================
  # Gateway Service
  # ===================================
  gateway-service:
    ports: []  # Kein direkter Zugriff, nur via Nginx
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - Jwt__Secret=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
    restart: unless-stopped

  # ===================================
  # Auth Service
  # ===================================
  auth-service:
    ports: []  # Kein direkter Zugriff
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__PostgreSQL=Host=postgres;Database=${POSTGRES_DB:-messenger_production};Username=${POSTGRES_USER:-messenger_prod};Password=${POSTGRES_PASSWORD}
      - Jwt__Secret=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
      - Jwt__AccessTokenExpirationMinutes=${JWT_EXPIRY_MINUTES:-15}
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY}
      - Redis__Password=${REDIS_PASSWORD}
    restart: unless-stopped

  # ===================================
  # Message Service
  # ===================================
  message-service:
    ports: []
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__MessageDatabase=Host=postgres;Database=messenger_messages;Username=${POSTGRES_USER:-messenger_prod};Password=${POSTGRES_PASSWORD}
      - Jwt__SecretKey=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__UserName=${RABBITMQ_USER:-messenger_prod}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD}
      - Redis__Password=${REDIS_PASSWORD}
    restart: unless-stopped

  # ===================================
  # User Service
  # ===================================
  user-service:
    ports: []
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__UserDatabase=Host=postgres;Database=messenger_users;Username=${POSTGRES_USER:-messenger_prod};Password=${POSTGRES_PASSWORD}
      - Jwt__Secret=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-MessengerProductionAuthService}
      - Jwt__Audience=${JWT_AUDIENCE:-MessengerProductionClient}
    restart: unless-stopped

  # ===================================
  # PostgreSQL (kein externer Zugriff)
  # ===================================
  postgres:
    ports: []  # Nur intern erreichbar
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-messenger_production}
      - POSTGRES_USER=${POSTGRES_USER:-messenger_prod}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    restart: unless-stopped

  # ===================================
  # Redis (kein externer Zugriff)
  # ===================================
  redis:
    ports: []
    command: redis-server --requirepass ${REDIS_PASSWORD}
    restart: unless-stopped

  # ===================================
  # RabbitMQ (kein externer Zugriff)
  # ===================================
  rabbitmq:
    ports: []
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-messenger_prod}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
    restart: unless-stopped

# ===================================
# Networks (same as base)
# ===================================
networks:
  messenger_network:
    driver: bridge

# ===================================
# Volumes (persistent data)
# ===================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
